@page "/learningpage/{UserId:int}/{ChapterId:int}"
@using SEIIApp.Shared.DomainDto.StatusDto
@using SEIIApp.Shared.DomainDto
@inject Services.BackendAccessService BackendAccessService
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager


<h3 align="center" style="margin:32px">Learning Page for Chapter: "@currentChapter" of Course "@currentCourseName"</h3>

<style>
    p {
        width: 30em;
        padding-top: 100px;
    }
</style>


<div style="text-align: center">
    <button class="btn btn-primary" @onclick="() => DownloadContent(pdfContent[0])"style="margin-top:24px">Download PDF</button><br><br>
    <button class="btn btn-primary" @onclick="RouteToQuizpage" style="margin-bottom:24px">Go to Quiz</button>

</div>

<style>
    p {
        width: 30em;
        padding-top: 100px;
    }
</style>


@if (VideoSource != null)
{
    <div style="text-align: center">

        <iframe width="560" height="315" src="@VideoSource" title="YouTube video player"
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
        </iframe>
    </div>
}
<br/>
<br/>
<a href="/homepageuser/@UserId">Back to your User Homepage</a>

@code
{
    [Parameter]
    public int UserId { get; set; }

    [Parameter]
    public int ChapterId { get; set; }

    public int QuizId { get; set; }

    string currentChapter = "";

    string currentCourseName = $"'Ein sehr guter Kurs!'";

    PdfContentDto[] pdfContent = new PdfContentDto[0];

    ChapterDto chapter;

    string VideoSource;


    private async void DownloadContent(PdfContentDto contentDto)
    {
        var getContent = await BackendAccessService.GetContentById(contentDto.ContentId);

        string[] base64String = getContent.baseString.Split(',');

        await JsRuntime.InvokeVoidAsync("downloadFile", "application/pdf", base64String[1], getContent.ContentName);
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
    //content = await BackendAccessService.GetAllContent();
        chapter = await BackendAccessService.GetChapterById(ChapterId);
        pdfContent = chapter.ChapterContentPdf;
        currentChapter = chapter.ChapterName;

        VideoSource = chapter.ChapterContentVideo.FirstOrDefault()?.Path;

        await BackendAccessService.AddOrUpdateChapterStatus(new chapterStatusTransfer() {ChapterId = chapter.ChapterId, UserId = UserId});

        var course = await BackendAccessService.GetCourseByChapterId(ChapterId);
        var courseId = course.CourseId;
        await BackendAccessService.AddOrUpdateCourseStatus(new CourseStatusTransfer() {CourseId = courseId, StudentId = UserId});

        var currentCourse = await BackendAccessService.GetCourseByChapterId(ChapterId);
        currentCourseName = currentCourse.CourseName;

        StateHasChanged();
    }

    private void RouteToQuizpage()
    {
        QuizId = chapter.ChapterQuiz.QuizId;
        NavigationManager.NavigateTo($"/chapterquiz/{UserId}/{QuizId}");
    }
}